name: üì¶ Dependency Updates & Security

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  # üîí Security Audit
  security-audit:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üîç Run security audit
        run: |
          echo "üîç Running security audit..."
          pnpm audit --audit-level moderate --json > audit-results.json || true
          
          # Check if there are any vulnerabilities
          if [ -s audit-results.json ]; then
            echo "‚ö†Ô∏è Security vulnerabilities found!"
            cat audit-results.json
            
            # Create issue if vulnerabilities found
            echo "VULNERABILITIES_FOUND=true" >> $GITHUB_ENV
          else
            echo "‚úÖ No security vulnerabilities found"
            echo "VULNERABILITIES_FOUND=false" >> $GITHUB_ENV
          fi

      - name: üö® Create security issue
        if: env.VULNERABILITIES_FOUND == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let auditResults = '';
            
            try {
              auditResults = fs.readFileSync('audit-results.json', 'utf8');
            } catch (error) {
              auditResults = 'Unable to read audit results';
            }
            
            const issueBody = `
            ## üö® Security Vulnerabilities Detected
            
            **Date:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            
            ### Audit Results
            \`\`\`json
            ${auditResults}
            \`\`\`
            
            ### Recommended Actions
            1. Review the vulnerabilities listed above
            2. Update affected packages to secure versions
            3. Run \`pnpm audit --fix\` to automatically fix issues
            4. Test the application after updates
            
            ### Auto-generated by GitHub Actions
            This issue was automatically created by the dependency security audit workflow.
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['security', 'dependencies', 'automated']
            });

  # üì¶ Dependency Updates
  dependency-updates:
    name: üì¶ Check for Updates
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üîç Check for outdated packages
        run: |
          echo "üîç Checking for outdated packages..."
          pnpm outdated --format json > outdated.json || true
          
          if [ -s outdated.json ]; then
            echo "üì¶ Outdated packages found!"
            cat outdated.json
            echo "UPDATES_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "‚úÖ All packages are up to date"
            echo "UPDATES_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: üîÑ Create update PR
        if: env.UPDATES_AVAILABLE == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let outdatedPackages = '';
            
            try {
              outdatedPackages = fs.readFileSync('outdated.json', 'utf8');
            } catch (error) {
              outdatedPackages = 'Unable to read outdated packages';
            }
            
            const issueBody = `
            ## üì¶ Dependency Updates Available
            
            **Date:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            
            ### Outdated Packages
            \`\`\`json
            ${outdatedPackages}
            \`\`\`
            
            ### Recommended Actions
            1. Review the outdated packages listed above
            2. Update packages using \`pnpm update\`
            3. Test the application thoroughly after updates
            4. Check for breaking changes in package changelogs
            
            ### Auto-generated by GitHub Actions
            This issue was automatically created by the dependency update workflow.
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üì¶ Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['dependencies', 'maintenance', 'automated']
            });

  # üè• Health Check
  health-check:
    name: üè• Application Health Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: üåê Check production deployment
        run: |
          echo "üåê Checking production deployment health..."
          
          # Replace with your actual production URL
          PROD_URL="https://v0-wakanda-bi-dashboard.vercel.app"
          
          # Health check
          if curl -f -s "$PROD_URL" > /dev/null; then
            echo "‚úÖ Production site is accessible"
          else
            echo "‚ùå Production site is not accessible"
            exit 1
          fi
          
          # API health check
          if curl -f -s "$PROD_URL/api/health" > /dev/null; then
            echo "‚úÖ API is healthy"
          else
            echo "‚ö†Ô∏è API health check failed (this might be expected if no health endpoint exists)"
          fi

      - name: üö® Create health issue
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const issueBody = `
            ## üö® Production Health Check Failed
            
            **Date:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run:** ${context.runNumber}
            
            ### Issue
            The production deployment health check has failed. The application may be down or experiencing issues.
            
            ### Recommended Actions
            1. Check the production deployment status
            2. Review recent deployments for issues
            3. Check application logs
            4. Verify all services are running correctly
            
            ### Auto-generated by GitHub Actions
            This issue was automatically created by the health check workflow.
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Production Health Check Failed - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['production', 'health-check', 'urgent', 'automated']
            });